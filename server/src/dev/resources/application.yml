logging:
  level:
    root: "info"

server:
  port: 8080
  jetty:
    threads:
      max-queue-capacity: 100

spring:
  application:
    name: openvsx-server
  autoconfigure:
    # don't send traces to Zipkin in development
    exclude: org.springframework.boot.actuate.autoconfigure.tracing.zipkin.ZipkinAutoConfiguration
  profiles:
    include: ovsx
# connect to redis cluster configured in docker-compose.yml
#  data:
#    redis:
#      cluster:
#        nodes: '127.0.0.1:7001,127.0.0.1:7002,127.0.0.1:7003,127.0.0.1:7004,127.0.0.1:7005,127.0.0.1:7006'
#      username: openvsx
#      password: openvsx
  datasource:
    url: jdbc:postgresql://localhost:5432/postgres
    username: openvsx
    password: openvsx
  flyway:
    baseline-on-migrate: true
    baseline-version: 0.1.0
    baseline-description: JobRunr tables
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: none
  session:
    store-type: jdbc
    jdbc:
      initialize-schema: never
  thymeleaf:
    # explicitly disable thymeleaf view resolution
    enabled: false

  security:
      oauth2:
        client:
          registration:
            eclipse:
              authorization-grant-type: authorization_code
              redirect-uri: http://localhost/login/oauth2/code/eclipse
              scope: openvsx_publisher_agreement, profile
          provider:
            eclipse:
              authorization-uri: https://accounts.eclipse.org/oauth2/authorize
              token-uri: https://accounts.eclipse.org/oauth2/token
              user-info-uri: https://accounts.eclipse.org/oauth2/UserInfo
              user-name-attribute: name
              user-info-authentication-method: header

management:
  health:
    probes:
      enabled: true
  endpoints:
    web:
      exposure:
        include:
          - health
          - metrics
          - prometheus
  metrics:
    distribution:
      percentiles-histogram:
        http:
          server:
            requests: true
          client:
            requests: true

springdoc:
  model-and-view-allowed: true
  swagger-ui:
    path: /swagger-ui
    docExpansion: list
    operationsSorter: alpha
    urlsPrimaryName: Registry API
    supportedSubmitMethods:
      - get

org:
  jobrunr:
    job-scheduler:
      enabled: true
    background-job-server:
      enabled: true
      worker-count: 2
    dashboard:
      enabled: false
    database:
      type: sql
    miscellaneous:
      allow-anonymous-data-usage: false

bucket4j:
  enabled: false
#  cache-to-use: jcache # use redis-jedis for redis standalone or redis-cluster-jedis for redis cluster
#  filters:
#    - cache-name: buckets
#      url: '/api/-/(namespace/create|publish)'
#      http-response-headers:
#        Access-Control-Allow-Origin: '*'
#        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
#      rate-limits:
#        - cache-key: getParameter("token")
#          bandwidths:
#            - capacity: 15
#              time: 1
#              unit: seconds
#    - cache-name: buckets
#      url: '/vscode/asset/.*/.*/.*/Microsoft.VisualStudio.Services.Icons.Default'
#      http-response-headers:
#        Access-Control-Allow-Origin: '*'
#        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
#      rate-limits:
#        - cache-key: getRemoteAddr()
#          bandwidths:
#            - capacity: 75
#              time: 1
#              unit: seconds
#    - cache-name: buckets
#      url: '/vscode/(?!asset/.*/.*/.*/Microsoft.VisualStudio.Services.Icons.Default).*|/api/(?!(.*/.*/review(/delete)?)|(-/(namespace/create|publish))).*'
#      http-response-headers:
#        Access-Control-Allow-Origin: '*'
#        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
#      rate-limits:
#        - cache-key: getRemoteAddr()
#          bandwidths:
#            - capacity: 15
#              time: 1
#              unit: seconds

ovsx:
  databasesearch:
    enabled: true
  elasticsearch:
    enabled: false
    clear-on-start: true
  redis:
    enabled: false
  eclipse:
    base-url: https://api.eclipse.org
    publisher-agreement:
      timezone: US/Eastern
  extension-control:
    update-on-start: false
  integrity:
    key-pair: create
  registry:
    version: 'v0.32.0-dev'
  storage:
    local:
      directory: /tmp
  mail:
    from: no-reply@example.com
    revoked-access-tokens:
      subject: 'Open VSX Access Tokens Revoked'
      template: 'revoked-access-tokens.html'
  webui:
    url: "http://localhost:3000"
  server:
    url: "http://localhost:8080"
  # dynamic tier-based rate limiting configuration
  rate-limit:
    enabled: false
    ip-address-function: '(getHeader("X-Forwarded-For")?: getRemoteAddr()).split(",")[0].trim()'
    usage-stats:
      job-schedule: '*/30 * * * *'
    filters:
      - url: '/(api|vscode)/.*'
        http-response-headers:
          Access-Control-Allow-Origin: '*'
          Access-Control-Expose-Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset, Retry-After
    default-http-content-type: application/json
    default-http-response-body: >
      {
        "type": "https://open-vsx.org/probs/rate-limit-exceeded",
        "title": "Too Many Requests",
        "status": 429,
        "detail": "A request rate limit has been exceeded for your current usage tier. Open VSX enforces tier-based limits to ensure reliable service. If this is unexpected for your use case, please contact us.",
        "documentation": "https://github.com/EclipseFdn/open-vsx.org/wiki/Rate-Limiting",
        "contact": "infrastructure@eclipse-foundation.org"
      }
  scanning:
    enabled: true
    # Shared archive limits for all scanning checks (secret detection, blocklist, etc.)
    max-archive-size-bytes: 1073741824   # 1 GB total archive limit
    max-single-file-bytes: 268435456     # 256 MB per-file limit
    max-entry-count: 100000              # Max ZIP entries to process
    blocklist-check:
      enabled: true
      enforced: false
      required: false
    similarity:
      enabled: true
      enforced: false
      required: false
      similarity-threshold: 0.2
      skip-if-publisher-verified: false
      only-protect-verified-names: false
      allow-similarity-to-own-names: true
      only-check-new-extensions: true
    secret-detection:
      enabled: true
      enforced: false
      required: false
      rules-path: 'classpath:scanning/secret-detection-custom-rules.yaml'
      suppression-markers: 'secret-detector:ignore,gitleaks:allow,nosecret,@suppress-secret'
      gitleaks:
        auto-fetch: true
        force-refresh: true
        output-path: '/tmp/secret-detection-rules-gitleaks.yaml'
        scheduled-refresh: true
        refresh-cron: '0 0 3 * * *'  # Daily at 3 AM
        skip-rule-ids: 'generic-api-key'  # Rule IDs that produce too many false positives
      max-findings: 200
      minified-line-threshold: 10000
      long-line-no-space-threshold: 1000
      regex-context-chars: 100
      debug-preview-chars: 10
      timeout-seconds: 10
      timeout-check-interval: 100
